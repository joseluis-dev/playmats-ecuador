---
import Badge from "@/components/Badge.astro";
import { Galery } from "@/components/Galery.tsx";
import { AddToCartButton } from "@/components/AddToCartButton.tsx";
import Layout from "@/layouts/Layout.astro";
import ArrowLeftIcon from "@/components/icons/ArrowLeftIcon.astro";
import FormattedDescription from "@/components/FormattedDescription.astro";
import { Image } from "astro:assets";
import type { Product, Resource } from "@/types";
import { api } from "@/services/api";

const { id } = Astro.params;

const PRODUCT = await api.get(`products/${id}`) as Product & {
  productResources: {
    resource: Resource;
    isBanner: boolean;
  }[];
};

const resources = PRODUCT.productResources.map(({ resource, isBanner }) => ({ ...resource, isBanner })) as Resource[];

---

<Layout title=`Playmats EC - ${PRODUCT.name}`>
  <section class="w-full max-w-screen-xl mx-auto
      p-8">
      <a id="back-link" href="#" class="flex w-fit gap-2 items-center mb-2 font-semibold group lg:hidden">
        <ArrowLeftIcon class="w-4 h-4 text-[var(--color-text)]/90 group-hover:text-[var(--color-text)] transition-colors duration-300 ease-in-out" />
        <span class="text-[var(--color-text)]/90 group-hover:text-[var(--color-text)] transition-colors duration-300 ease-in-out">Volver</span>
      </a>
    <div
      class="absolute top-0 left-0 bottom-0
        h-full w-full bg-[var(--color-background)]
        transition-scale duration-1000 ease-in-out
        opacity-30 -z-10
        bg-center bg-cover bg-no-repeat bg-blend-luminosity"
      style={`background-image: url(${resources.find((r) => r.isBanner)?.url || resources[0]?.url});`}
    >
    </div>

    <div class="flex justify-between items-center w-full mb-2">
      <h2
        transition:name={`title-${PRODUCT.id}`}
        class="text-xl w-full lg:max-w-2xl xl:max-w-3xl font-semibold text-balance dark:text-[var(--color-primary)] text-[var(--color-text)] bg-[var(--color-surface)]/70 p-2 rounded-lg"
      >
        {PRODUCT.name}
      </h2>

      <a id="back-link-desktop" href="#" class="hidden w-fit gap-2 items-center font-semibold group lg:flex">
        <ArrowLeftIcon class="w-4 h-4 text-[var(--color-text)]/90 group-hover:text-[var(--color-text)] transition-colors duration-300 ease-in-out" />
        <span class="text-[var(--color-text)]/90 group-hover:text-[var(--color-text)] transition-colors duration-300 ease-in-out">Volver</span>
      </a>
    </div>

    <div class="flex flex-col lg:flex-row gap-4 w-full">
      <Galery client:visible resources={resources}/>
      <div class="flex flex-col gap-4 w-full lg:max-w-[35%]">
        <Image
          src={PRODUCT.productResources.filter((image) => image.isBanner)[0]?.resource?.url || resources[0]?.url || ''}
          transition:name={`img-${id}`}
          width={100}
          height={100}
          alt="Banner Image"
          class="rounded-lg hidden lg:block object-cover aspect-video w-full"
          loading="lazy"
        />
        <div class="flex flex-col gap-4 w-full h-full bg-[var(--color-surface)]/70 rounded-lg p-4">
          <div class="flex flex-col gap-2 h-full md:max-h-48 overflow-auto">
            <FormattedDescription text={PRODUCT.description || ''} />
            <div class="flex flex-wrap gap-2 p-[1px]">
              {
                PRODUCT.categories?.map((category) => (
                  <Badge
                    color={category.color}
                    label={category.name}
                    type="outline"
                  />
                ))
              }
              {
                PRODUCT.attributes?.map((attribute) => (
                  <Badge
                    color={attribute.color}
                    label={attribute.name}
                    type="outline"
                  />
                ))
              }
            </div>
          </div>
          <div class="flex justify-end">
            <AddToCartButton
              client:visible
              className={`
                flex items-center justify-center gap-2
                px-4 py-2 ring-1 ring-blue-500/20 dark:ring-white/20
                rounded-lg bg-[var(--color-primary)]/90
                hover:bg-[var(--color-primary)]
                transition-colors duration-300 ease-in-out
              `}
              label="Añadir"
              product={PRODUCT}
            />
          </div>
        </div>
      </div>
    </div>
  </section>
</Layout>

<script>
  document.addEventListener("astro:page-load", () => {
    const backLink = document.querySelector('#back-link');
    const backLinkDesktop = document.querySelector('#back-link-desktop');
    backLink?.addEventListener('click', (e) => {
      e.preventDefault();

      // Si el referrer es del mismo dominio, vuelve atrás
      const isInternal = document.referrer && document.referrer.startsWith(window.location.origin);

      if (isInternal) {
        window.history.back();
      } else {
        // Si no hay referrer (acceso directo), ir a catálogo
        window.location.href = '/cataloge';
      }
    });
    backLinkDesktop?.addEventListener('click', (e) => {
      e.preventDefault();

      // Si el referrer es del mismo dominio, vuelve atrás
      const isInternal = document.referrer && document.referrer.startsWith(window.location.origin);

      if (isInternal) {
        window.history.back();
      } else {
        // Si no hay referrer (acceso directo), ir a catálogo
        window.location.href = '/cataloge';
      }
    });
  });
</script>